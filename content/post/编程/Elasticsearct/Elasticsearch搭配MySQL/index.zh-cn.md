---
title: Elasticsearch搭配MySQL
description: Elasticsearch搭配MySQL
date: 2025-06-09
slug: Elasticsearch搭配MySQL
image: 202412212115512.png
categories:
    - Elasticsearch
---

# Elasticsearch搭配MySQL

## 单用MySQL的痛点

1. 单表数据承载有限度，不严谨的说:超过千万就要考虑分表
2. 全文检索场景在MySQL中弱爆了，ngram fulltext索引就是玩笑
3. Innodb索引的B+树(左侧列原则)要根据不同的场景创建超多索引，导致写性能爆炸

## 使用ES构建索引+Hash分表实现

![image-20250609221018323](https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo05/202506092210440.png)



用户在筛选了条件以及输入检索关键词之后，先显示查询结果页面，主要包含以下信息

1. 封面图
2. 价格
3. 标题
4. 评价数量
5. 店铺信息

那么此时其实已经查询出了商品的id列表，这是一个存储id的集合。此时可以使用id号对n进行取模（hash分表）

到对应的数据库中把完整的商品信息提取出来

1. 商品基本信息
2. 封面信息
3. 轮播图信息
4. 规格信息
5. 评论信息等等...

## 为什么不直接使用ES存储所有的商品数据

1. 非关系型表达，大量的反范式存储,导致维护基础数据异常(新增异常,修改异常,删除异常) , 需要MySQL做托底
2. 不支持事务，一致性需要自 己维护
3. 从存储的角度来说，Elasticsearch是基于 “字段”的，大行超多字段性能并不好

## ES、MySQL数据同步问题

![image-20250609222431673](https://raw.githubusercontent.com/IsUnderAchiever/markdown-img/master/PicGo05/202506092224820.png)

**数据同步方案**：

**1、同步双写**

应用的数据，同步双写到mysql和es

优点：

1、业务简单；

2、实时性高；

缺点：

1、硬编码，有mysql写入，就要写写入es的代码

2、业务强耦合

3、双写业务丢失

4、两个都写降低性能，增加单位方法的耗时和性能

2、异步双写（应用双写）（MQ异步）

**2、借助mq实现异步的多源写入**

优点：

1、性能高；

2、不易出现数据丢失问题；（主要来源于mq消息的消费保障机制，比如es宕机或写入失败还能重新消费mq消息）；

3、多源写入之间相互隔离。便于扩展更多的数据源写入

缺点：

1、硬编码，接入新的数据源需要实现新的消费者代码；

2、系统复杂度增加，映入了消息中间件

3、数据实时问题，mq是异步消费，用户输入，不一定会马上同步让他看到

3、基于sql抽取（定时任务）

**3、用定时器处理，常用方案新增一个timestamp字段，比较此字段来确认变更数据。再写入es**

优点：

1、不改原代码，没有硬编码；

2、没有业务强耦合，不改变原来程序的性能；

3、worker代码编写简单，不需要考虑增删改查；

缺点：

1、对mysql的轮训压力

2、数据有时间延迟

优化的方案：

1、轮寻放到压力不大的从库上

2、借助logstash实现数据同步

4、基于Binlog实时同步

实施步骤 

1、读取mysql 的binlog日志，获取指定表的日志信息；

2、将读取的信息转为mq；

3、编写一个mq消费程序；

4、不断消费mq，每费完一条消息，将消息写入到es中；

数据迁移工具

1、canal （原理是伪装成mysql的从数据库）

2、阿里云DTS （需付费）

3、databus

4、Flink

5、CloudCanal

6、Maxwell

